<?php

namespace App\Http\Controllers;

use App\Models\Item;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class ItemController extends Controller
{
    /**
     * ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
     * ã“ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å†…ã®å…¨ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã¨ã™ã‚‹
     */
    public function __construct()
    {
        // 'auth' ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’é©ç”¨ã—ã€indexã¨showãƒ¡ã‚½ãƒƒãƒ‰ã‚’é™¤å¤–ã™ã‚‹
        $this->middleware('auth')->except(['index', 'show']);
    }

    /**
     * ãƒ›ãƒ¼ãƒ ç”»é¢ (å•†å“ä¸€è¦§) ã‚’è¡¨ç¤ºã™ã‚‹
     * æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
     */
    public function index()
    {
        // è²©å£²ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæœªè²©å£²ï¼ˆis_sold = 0/falseï¼‰ã®å•†å“ã®ã¿ã‚’å–å¾—
        // æœ€æ–°ã®å•†å“ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«é™é †ã§å–å¾—
        $items = Item::where('is_sold', false)
                    ->orderBy('created_at', 'desc')
                    ->get();

        // 'items.index' ãƒ“ãƒ¥ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦è¡¨ç¤º
        return view('items.index', compact('items'));
    }

    /**
     * å•†å“è©³ç´°ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ (é‡è¤‡å®šç¾©ã‚’ä¿®æ­£ã—ã€ã„ã„ã­æƒ…å ±ã‚’è¿½åŠ )
     * æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
     *
     * @param Item $item ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‹ã‚‰è‡ªå‹•çš„ã«å–å¾—ã•ã‚ŒãŸå•†å“ãƒ‡ãƒ¼ã‚¿
     * @return \Illuminate\View\View
     */
    public function show(Item $item) // å‹ãƒ’ãƒ³ãƒˆã¯ Item $item ã®æ–¹ãŒæ¨å¥¨ã•ã‚Œã¾ã™
    {
        // ğŸ’¡ N+1å•é¡Œå¯¾ç­–ã¨ä¸¦ã³æ›¿ãˆã‚’åŒæ™‚ã«è¡Œã„ã¾ã™ã€‚
        // with() ã§ã¯ãªã load() ã‚’ä½¿ç”¨ã—ã¦ã€æ—¢ã«å–å¾—ã•ã‚ŒãŸ $item ã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã§ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
        $item->load([
            // ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ–°ã—ã„é †ï¼ˆcreated_at ã®é™é †ï¼‰ã§å–å¾—ã—ã€åŒæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚‚ãƒ­ãƒ¼ãƒ‰
            'comments' => function ($query) {
                $query->orderBy('created_at', 'desc')->with('user');
            },
            // ã„ã„ã­ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆlikedUsersï¼‰ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠãã¨åŠ¹ç‡çš„ã§ã™
            'likedUsers',
        ]);

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã„ã­ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã®ç¢ºèª
        $isLiked = false;
        if (Auth::check()) {
            // ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã® likedUsers ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã€ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            // æ—¢ã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€DBã‚¯ã‚¨ãƒªã¯ç™ºç”Ÿã—ã¾ã›ã‚“
            $isLiked = $item->likedUsers->contains('id', Auth::id());
        }

        // ã„ã„ã­åˆè¨ˆæ•°ã®å–å¾— (ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã® count() ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™)
        $likeCount = $item->likedUsers->count();

        // å•†å“è©³ç´°ãƒ“ãƒ¥ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦è¡¨ç¤º
        return view('items.show', compact('item', 'isLiked', 'likeCount'));
    }
}
