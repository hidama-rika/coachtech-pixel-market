<?php

namespace App\Http\Controllers;

use App\Models\Item;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class ItemController extends Controller
{
    /**
     * ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
     * ã“ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å†…ã®å…¨ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã¨ã™ã‚‹
     */
    public function __construct()
    {
        // 'auth' ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’é©ç”¨ã—ã€indexã¨showãƒ¡ã‚½ãƒƒãƒ‰ã‚’é™¤å¤–ã™ã‚‹
        $this->middleware('auth')->except(['index', 'show']);
    }

    /**
     * ãƒ›ãƒ¼ãƒ ç”»é¢ (å•†å“ä¸€è¦§) ã‚’è¡¨ç¤ºã™ã‚‹
     * æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
     */
    public function index()
    {
        // è²©å£²ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæœªè²©å£²ï¼ˆis_sold = 0/falseï¼‰ã®å•†å“ã®ã¿ã‚’å–å¾—
        // æœ€æ–°ã®å•†å“ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«é™é †ã§å–å¾—
        $items = Item::where('is_sold', false)
                    ->orderBy('created_at', 'desc')
                    ->get();

        // 'items.index' ãƒ“ãƒ¥ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦è¡¨ç¤º
        return view('items.index', compact('items'));
    }

    /**
     * å•†å“è©³ç´°ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
     * æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
     */
    public function show(Item $item)
    {
        // $item ã«ã¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‹ã‚‰è‡ªå‹•çš„ã«å–å¾—ã•ã‚ŒãŸå•†å“ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã‚‹

        // â— ä¿®æ­£ç®‡æ‰€: ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ–°ã—ã„é †ï¼ˆcreated_at ã®é™é †ï¼‰ã§å–å¾—ã™ã‚‹ã‚ˆã†ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ â—
        $item->load([
            // 'comments' ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚’ä½¿ã£ã¦ä¸¦ã³é †ã‚’æŒ‡å®š
            'comments' => function ($query) {
                $query->orderBy('created_at', 'desc');
            },
            // ã‚³ãƒ¡ãƒ³ãƒˆã¨åŒæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚‚ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºã«å¿…è¦ï¼‰
            'comments.user',
            // ğŸ’¡ å¿…è¦ã«å¿œã˜ã¦ã€ã„ã„ã­æƒ…å ±ãªã©ã‚‚ã“ã“ã§ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠãã¨N+1å•é¡Œã‚’é˜²ã’ã¾ã™
            // 'likes',
            // 'likes.user',
        ]);

        // å•†å“è©³ç´°ãƒ“ãƒ¥ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦è¡¨ç¤º
        // ãƒ“ãƒ¥ãƒ¼å´ã§ã¯ã€å–å¾—ã•ã‚ŒãŸ $item->comments ã¯æ—¢ã«æ–°ã—ã„é †ã«ä¸¦ã‚“ã§ã„ã¾ã™
        return view('items.show', compact('item'));
    }
}
